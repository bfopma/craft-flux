"use strict";var S=require("querystring");var q=require("crypto");function u(e,...r){e.loggingEnabled&&console.log(r)}function F(e){return typeof e!="string"?!1:!isNaN(e)&&!isNaN(parseFloat(e))}var P="webp",C=(t=>(t.FIT="fit",t.CROP="crop",t.STRETCH="stretch",t))(C||{}),O=["jpg","png","webp"],A=["top-left","top-center","top-right","center-left","center-center","center-right","bottom-left","bottom-center","bottom-right"];function d(e,r){return Number.isInteger(parseInt(e))?parseInt(e):r}function M(e){return e.headers.accept?e.headers.accept[0].value:""}function N(e){let r=e.match(/_(\d+|AUTO)x(\d+|AUTO)_(fit|crop|stretch)_([a-z\d\\.]+-[a-z\d\\.]+)_?(\d+)?/);return r?r[0]:void 0}function v(e,r,n){if(!r.v)return!1;let t=n.verifySecret,o=e.uri.substring(1);o=Q(o,n);let i=e.querystring.split("&v=");return Object.keys(r).length>1&&i.length===2?(0,q.createHmac)("sha256",t).update(`${o}?${i[0]}`).digest("hex")===i[1]:!1}function w(e,r,n){let t=e.uri,o=M(e),i=t.match(/(.*)\/(.*)\.(.*)$/);if(!i||i.length<3)return null;let s=i[1];s.charAt(0)==="/"&&(s=s.substring(1));let c=i[2],g=i[3],f,l=g;e.headers["x-flux-source-filename"]&&(f=e.headers["x-flux-source-filename"][0].value);let x=N(s),h=Q(s.replace(`/${x}`,""),n),p=h.split("/").filter(a=>a),b=n.sources.find(a=>{let m=p[0];return m===n.rootPrefix&&(m=p[1]),a.handle===m});if(!b)return u(n,"Unable to parse source",h),u(n,"Available sources",n.sources.map(a=>a.handle)),null;let E=$(...p.slice(1));r.f&&O.includes(r.f)?l=r.f:n.acceptWebp&&o.includes(P)&&(l=P),!f&&g!==l&&(f=`${c}.${g}`);let y=_(r,l,n);return y?{prefix:s,fileName:c,extension:l,manipulations:y,source:b,sourcePath:E,sourceFilename:f,transformPathSegment:x}:null}function _(e,r,n){if(!e.mode||!e.w&&!e.h)return u(n,"Request must contain a mode and a width or height"),null;let t={mode:Object.values(C).includes(e.mode)?e.mode:"fit",width:"AUTO",height:"AUTO",position:"center-center"};if(t.width=d(e.w,t.width),t.height=d(e.h,t.height),e.pos){if(A.includes(e.pos))t.position=e.pos;else if(!Array.isArray(e.pos)&&e.pos.indexOf("-")!==-1){let o=e.pos.split("-");o.length===2&&o.every(i=>F(i))&&(t.position={x:parseFloat(o[0]),y:parseFloat(o[1])})}}if(e.q){let o=d(e.q,0);o>0&&(t.quality=o)}else r=="jpg"?t.quality=n.jpegQuality:r=="webp"&&(t.quality=n.webpQuality);return t}function R(e){let r=e.manipulations,n=`_${r.width}x${r.height}_${r.mode}_`;return typeof r.position=="string"?n+=r.position:n+=`${r.position.x.toFixed(3)}-${r.position.y.toFixed(3)}`,r.quality&&(n+=`_${r.quality}`),$(e.prefix,n,`${e.fileName}.${e.extension}`)}function $(...e){return e.filter(r=>r&&r.length>0).join("/")}function Q(e,r){return e.startsWith(`/${r.rootPrefix}`)||e.startsWith(`${r.rootPrefix}/`)?e.slice(r.rootPrefix.length+1):e}var T={loggingEnabled:!0,rootPrefix:"Flux",sources:[],verifyQuery:!0,verifySecret:"",cachedEnabled:!0,bucket:"",region:"",jpegQuality:80,webpQuality:80,acceptWebp:!0};var j=(e,r,n)=>{let t=e.Records[0].cf.request,o=T;if(global&&global.fluxConfig)o=Object.assign({},o,global.fluxConfig);else return u(o,"Forwarding request, no config accessible"),n(null,t);u(o,"Parsing request",t.uri,t.querystring);let i=(0,S.parse)(t.querystring);if(o.verifyQuery&&!v(t,i,o))return u(o,"Forwarding request, query verification failed"),n(null,t);let s=w(t,i,o);return s?(t.uri="/"+R(s),u(o,"Modifying path to",t.uri),s.sourceFilename&&(t.headers["x-flux-source-filename"]=[{key:"X-Flux-Source-Filename",value:s.sourceFilename}]),n(null,t)):(u(o,"Forwarding request, unable to parse"),n(null,t))};exports.handler=j;
/*!
 * Flux
 * Copyright(c) Chris Dyer
 */
//# sourceMappingURL=index.js.map
